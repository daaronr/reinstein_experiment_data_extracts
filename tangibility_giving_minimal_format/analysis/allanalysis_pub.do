*File: allanalysis_pub.do
* This file will contain the commands used to create all of the tables, graphs, etc., in the published paper, including any appendices

***Drive information 
global basedir "/Users/david/Dropbox/experiment_data_extracts/tangibility_giving"
*global basedir "C:\Users\drein\Dropbox/experiment_data_extracts/tangibility_giving"
*Replace with your own base directory

global datasetname "housemoney"

clear
cd "${basedir}"

use output_data/${datasetname}1.dta, clear

*Move to directory to output tables
cd paper_plus/tables_graphs

*** Main paper ***

	*** Table 1: Average proportion contributed by payment regimes 
	*Creates "cashperformance_2way.tex", minor edits for table format done by hand
	
	// generate p value from z value gen pv=2*(1-norm(abs(Z)))

		ranksum DonRatio, by(cash) porder
		global test_cash=round(r(porder),0.01)
		global pv_test_cash=round(2*(1-normal(abs(r(z)))),0.01)
		
		ranksum DonRatio, by(performance) porder
		global test_perform=round(r(porder),0.01)
		global pv_test_perform=round(2*(1-normal(abs(r(z)))),0.01)
		
		ranksum DonRatio if performance==1, by(cash) porder
		global test_cash_perf_1=round(r(porder),0.01)
		global pv_test_cash_perf_1=round(2*(1-normal(abs(r(z)))),0.01)
		
		ranksum DonRatio if performance==0, by(cash) porder
		global test_cash_perf_0=round(r(porder),0.01)
		global pv_test_cash_perf_0=round(2*(1-normal(abs(r(z)))),0.01)
		
		ranksum DonRatio if cash==1, by(performance) porder
		global test_perf_cash_1=round(r(porder),0.01)
		global pv_test_perf_cash_1=round(2*(1-normal(abs(r(z)))),0.01)
		
		ranksum DonRatio if cash==0, by(performance) porder
		global test_perf_cash_0=round(r(porder),0.01)
		global pv_test_perf_cash_0=round(2*(1-normal(abs(r(z)))),0.01)
		
		gen comp=0
		replace comp=1 if cash==0&performance==0
		replace comp=2 if cash==1&performance==1
		
		ranksum DonRatio if comp>0, by(comp) porder
		global test_perf01_cash_01=round(r(porder),0.01)
		global pv_test_perf01_cash_01=round(2*(1-normal(abs(r(z)))),0.01)
		
		drop comp
		gen comp=0
		replace comp=1 if cash==0&performance==1
		replace comp=2 if cash==1&performance==0
		
		ranksum DonRatio if comp>0, by(comp) porder
		global test_perf01_cash_10=round(r(porder),0.01)
		global pv_test_perf01_cash_10=round(2*(1-normal(abs(r(z)))),0.01)
		
		drop comp
		
		
		** Create table from stats above:
		tabout cash performance using cashperformance_2way.tex, sum style(tex) c(mean DonRatio) f(2) topstr(lccccc) topf(top.tex) botstr(${test_cash}|${pv_test_cash}|${test_perform}|${pv_test_perform}|${test_perf01_cash_01}|${pv_test_perf01_cash_01}|${test_cash_perf_0}|${pv_test_cash_perf_0}|${test_cash_perf_1}|${pv_test_cash_perf_1}|${test_perf01_cash_10}|${pv_test_perf01_cash_10}) botf(teststat.tex) npos(both) h3(nil) replace


	*** Figure 1: Cumulative distribution functions of share of earnings donated
	*(cdf_DonRatio_cash.png, cdf_DonRatio_performance.png)
	
    *-- Note, requires stata ado file 'cdfplot' 
	
	cdfplot DonRatio, by(cash) 
	graph export cdf_DonRatio_cash.png, replace
	cdfplot DonRatio, by(performance)
	graph export cdf_DonRatio_performance.png, replace

	
	*** Table 2: Number of subjects who donated by treatment
		** (note -- also done as bootstrap to test balance issue)
		** Note: statistics in table generated by commmands below; table generation command lost, but may have been input by hand
				
		gen biDon = Donation>0
		tab biDon perform, col chi2 exact
		tab biDon cash, col chi2 exact
		
		
	*** Table 3: Poisson and OLS regression of total donations
		** Outputs PoissonTreatJANED.tex, which was further edited by hand for style
				/*Poisson regressions*/				poisson Donation cash performance cashperf, robust		mfx,at(cash = 0,performance = 0, cashperf = 0)		eststo Poisson_1				lincom cash+performance+cashperf		global Pois_1_treat: display %9.2f =round(r(estimate),0.01)		global Pois_1_treat_se: display %9.2f =round(r(se),0.01)				poisson Donation cash performance cashperf shock stake75 stake10, robust		mfx,at(cash = 0,performance = 0, cashperf = 0, shock=0, stake75=1, stake10=0)		eststo Poisson_2				lincom cash+performance+cashperf		global Pois_2_treat: display %9.2f =round(r(estimate),0.01)		global Pois_2_treat_se: display %9.2f =round(r(se),0.01)				poisson Donation cash performance cashperf shock stake75 stake10 female , robust		mfx,at(cash = 0,performance = 0, cashperf = 0, shock=0, stake75=1, stake10=0, female=1)		eststo Poisson_3				lincom cash+performance+cashperf		global Pois_3_treat: display %9.2f =round(r(estimate),0.01)		global Pois_3_treat_se: display %9.2f =round(r(se),0.01)				/*OLS regressions*/				reg Donation cash performance cashperf		eststo OLS_1				lincom cash+performance+cashperf		global OLS_1_treat: display %9.2f =round(r(estimate),0.01)		global OLS_1_treat_se: display %9.2f =round(r(se),0.01)						reg Donation cash performance cashperf shock stake75 stake10		eststo OLS_2				lincom cash+performance+cashperf		global OLS_2_treat: display %9.2f =round(r(estimate),0.01)		global OLS_2_treat_se: display %9.2f =round(r(se),0.01)				reg Donation cash performance cashperf shock stake75 stake10 female		eststo OLS_3				lincom cash+performance+cashperf		global OLS_3_treat: display %9.2f =round(r(estimate),0.01)		global OLS_3_treat_se: display %9.2f =round(r(se),0.01)				esttab Poisson_1 OLS_1 Poisson_2 OLS_2 Poisson_3 OLS_3 using "PoissonTreatJANED.tex",  booktabs replace b(a2)  nogaps  label compress pr2 nodepvars legend coeflabels(_cons "Constant")  starlevels(+ 0.10 * 0.05 ** 0.01) se mtitles("Psn." "OLS" "Psn." "OLS" "Psn." "OLS") mgroups(" "  "Add. contr." "Gender contr.", pattern(1 0 1 0 1 0) span prefix(\multicolumn{@span}{c}{) suffix(})) prefoot("\midrule" "\multicolumn{@span}{l}{\textit{Combined Coefficients}}\\" "Cash+perform+cash $\times$ perform & ${Pois_1_treat} & ${OLS_1_treat} & ${Pois_2_treat} &${OLS_2_treat} & ${Pois_3_treat}& ${OLS_3_treat} \\" " &  (${Pois_1_treat_se})&  (${OLS_1_treat_se})&  (${Pois_2_treat_se})&  (${OLS_2_treat_se})&  (${Pois_3_treat_se})&(${OLS_3_treat_se})\\" "\bottomrule") margin r2		
	
	
***	Appendix ***
**TODO, KRISTINA: See which of the below you can fill in. You must check that they produce output or tables that agree with the tables in 10683_2011_9298_MOESM2_ESM.pdf
* ... the code may be drawn from any of the files in the "tangibility_giving/analysis" folder or subfolders
* ... See what you can do but don't "get stuck" on any of these tables; as these are appendix tables they are not crucial for what I want to do right now


	*** Table A1: Extensive margin: Probit regressions of Positive Donation
	
	*** Table A2: Ratio of income donated (Papke-Wooldridge estimator)
	
		
		glm DonRatio cash performance cashperf, link(logit) family(binomial) robust
		eststo PW_1
		lincom cash+performance+cashperf
		global PW_1_treat: display %9.2f =round(r(estimate),0.01)
		global PW_1_treat_se: display %9.2f =round(r(se),0.01)
		
		
		glm DonRatio cash performance cashperf shock stake75 stake10, link(logit) family(binomial) robust
		eststo PW_2
		lincom cash+performance+cashperf
		global PW_2_treat: display %9.2f =round(r(estimate),0.01)
		global PW_2_treat_se: display %9.2f =round(r(se),0.01)
		
		glm DonRatio cash performance cashperf shock stake75 stake10 female, link(logit) family(binomial) robust
		eststo PW_3
		lincom cash+performance+cashperf
		global PW_3_treat: display %9.2f =round(r(estimate),0.01)
		global PW_3_treat_se: display %9.2f =round(r(se),0.01)
		
		esttab PW_1 PW_2 PW_3 using "ShareTreat.tex",  booktabs replace b(a2)  nogaps  label compress pr2 nodepvars legend coeflabels(_cons "Constant")  starlevels(* 0.10 ** 0.05 *** 0.01) se mtitles("Base" "Exp. Controls" "Add. controls") prefoot("\midrule" "\multicolumn{@span}{l}{\textit{Combined Coefficients}}\\" "Cash+perform+cash $\times$ perform & ${PW_1_treat} & ${PW_2_treat} & ${PW_3_treat} \\" " &  (${PW_1_treat_se})&  (${PW_2_treat_se})&  (${PW_3_treat_se}) \\" "\bottomrule") margin r2
		
	
	*** Table A3: Poisson regressions by charity
	
	*** (table A4 is the schedule of sessions)
	
	*** Table A5: Poisson and OLS regression on total donations
	
	*** Table A6: Percentage of subjects who donated to specific charity.
	
	*** Table A7: Answer to the question: “I trust that the charity uses the money as they state” (percentages giving each response)
	
	*** Table A8: Answer to the question: “What percentage of the money donated reaches the needy” (percentage giving each response)
	
	*** Table A9: Allocations by treatment (realized)
